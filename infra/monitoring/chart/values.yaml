# Hostname for Grafana ingress
grafanaHostname: grafana.app.example.com  # Override with actual hostname

kube-prometheus-stack:
  grafana:
    # Secret must be created manually before deploying:
    # kubectl create secret generic monitoring-grafana-admin \
    #   -n monitoring \
    #   --from-literal=admin-user=admin \
    #   --from-literal=admin-password=<your-password>
    admin:
      existingSecret: monitoring-grafana-admin
      userKey: admin-user
      passwordKey: admin-password

  prometheus-node-exporter:
    # Node-exporter defaults hostNetwork/hostPID to true; disable them
    # to reduce the attack surface.
    hostNetwork: false
    hostPID: false

  kube-state-metrics:
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: [ALL]

loki:
  deploymentMode: SingleBinary
  gateway:
    enabled: false
  loki:
    commonConfig:
      replication_factor: 1
    storage:
      type: filesystem
    limits_config:
      volume_enabled: true
    schemaConfig:
      configs:
        - from: "2024-01-01"
          store: tsdb
          object_store: filesystem
          schema: v13
          index:
            prefix: index_
            period: 24h
  singleBinary:
    replicas: 1
  backend:
    replicas: 0
  read:
    replicas: 0
  write:
    replicas: 0

alloy:
  # Alloy runs as a DaemonSet and mounts /var/log/pods (hostPath) to collect
  # container logs â€“ hostPath access is unavoidable for log collection.
  # Restrict everything else we don't need.
  alloy:
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: [ALL]
        add: [DAC_READ_SEARCH]  # Read pod log files owned by other users

  configMap:
    content: |
      logging {
        level = "info"
      }

      discovery.kubernetes "pods" {
        role = "pod"
      }

      discovery.relabel "pods" {
        targets = discovery.kubernetes.pods.targets
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }
      }

      loki.source.kubernetes "pods" {
        targets    = discovery.relabel.pods.output
        forward_to = [loki.write.default.receiver]
      }

      loki.write "default" {
        endpoint {
          url = "http://{{ .Release.Name }}-loki:3100/loki/api/v1/push"
        }
      }
