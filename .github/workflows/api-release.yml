name: Release - Deploy API

run-name: "${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}"

on:
  push:
    tags:
      - '@eventuras/api@*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., @eventuras/api@0.7.1)'
        required: true

env:
  ORGANIZATION_NAME: losolio
  IMAGE_NAME: eventuras

jobs:
  check-release:
    name: Check if API release
    runs-on: ubuntu-latest
    outputs:
      is_api_release: ${{ steps.check.outputs.is_api_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Check release tag
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi

          echo "Tag: $TAG"

          if [[ "$TAG" == @eventuras/api@* ]]; then
            echo "is_api_release=true" >> $GITHUB_OUTPUT
            VERSION="${TAG#@eventuras/api@}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "✅ This is an API release: $VERSION"
          else
            echo "is_api_release=false" >> $GITHUB_OUTPUT
            echo "⏭️ Not an API release, skipping"
          fi

  build-api:
    needs: check-release
    if: needs.check-release.outputs.is_api_release == 'true'
    uses: ./.github/workflows/api-main.yml

  docker:
    name: API - Docker image
    needs: [check-release, build-api]
    if: needs.check-release.outputs.is_api_release == 'true'
    runs-on: ubuntu-latest
    environment: api-prod
    defaults:
      run:
        working-directory: ./apps/api/

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api/
          push: true
          tags: ${{ env.ORGANIZATION_NAME }}/${{ env.IMAGE_NAME }}:${{ needs.check-release.outputs.version }}

  deploy-api:
    runs-on: ubuntu-latest
    needs: [check-release, docker]
    if: needs.check-release.outputs.is_api_release == 'true'
    environment: api-prod

    steps:
      - name: Deploy API to production
        id: deploy-to-azure
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          images: ${{ env.ORGANIZATION_NAME }}/${{ env.IMAGE_NAME }}:${{ needs.check-release.outputs.version }}
