name: idem-admin - CI/CD

on:
  push:
    branches:
      - main
      - "feature/**"
      - "feat/**"
      - "fix/**"
      - "bugfix/**"
      - "chore/**"
      - "release/**"
    paths:
      - "apps/idem-admin/**"
      - "libs/**"
      - ".github/workflows/idem-admin-main.yml"
  pull_request:
    branches: [main]
    paths:
      - "apps/idem-admin/**"
      - "libs/**"
      - ".github/workflows/idem-admin-main.yml"

concurrency:
  group: idem-admin-${{ github.workflow }}-${{ github.ref }}
  # Cancel in-progress for PRs to save resources, but not for main branch
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  ORG: losolio
  IMAGE_NAME: idem-admin
  # BuildKit endpoint (deployed in arc-systems namespace)
  BUILDKIT_HOST: tcp://buildkit.arc-systems.svc:1234

jobs:
  lint:
    name: Build & Push Docker Image
    runs-on: arc-eventuras
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --filter @eventuras/idem-admin... --frozen-lockfile

      - name: Lint
        run: pnpm --filter @eventuras/idem-admin lint

  docker:
    runs-on: arc-eventuras
    permissions:
      contents: read
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read package version
        id: ver
        shell: bash
        run: |
          PKG="apps/idem-admin/package.json"
          V="$(jq -r '.version' "$PKG" 2>/dev/null || echo '0.0.0')"
          echo "version=$V" >> "$GITHUB_OUTPUT"
          echo "sha=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      # Remote Buildx driver â€” offloads builds to the BuildKit StatefulSet
      - name: Set up Buildx (remote BuildKit)
        uses: docker/setup-buildx-action@v3
        with:
          driver: remote
          endpoint: ${{ env.BUILDKIT_HOST }}

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ORG }}/${{ env.IMAGE_NAME }}
          tags: |
            # Main branch: canary + main-<sha>
            type=raw,value=canary,enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=main-${{ steps.ver.outputs.sha }},enable=${{ github.ref == 'refs/heads/main' }}
            # Feature branches: edge + edge-<sha>
            type=raw,value=edge,enable=${{ github.ref != 'refs/heads/main' }}
            type=raw,value=edge-${{ steps.ver.outputs.sha }},enable=${{ github.ref != 'refs/heads/main' }}
          labels: |
            org.opencontainers.image.version=${{ steps.ver.outputs.version }}
            org.opencontainers.image.revision=${{ steps.ver.outputs.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}

      - name: Build & push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/idem-admin/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          # GitHub Actions cache is faster than registry cache
          cache-from: type=gha
          cache-to: type=gha,mode=max
          cache-from: type=registry,ref=${{ env.ORG }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: ${{ github.event_name != 'pull_request' && format('type=registry,ref={0}/{1}:buildcache,mode=max', env.ORG, env.IMAGE_NAME) || '' }}
          provenance: false
