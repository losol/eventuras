name: Historia CMS CI/CD

concurrency:
  group: historia-${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    paths:
      - 'apps/historia/**'
      - '.github/workflows/historia-main.yml'
  push:
    branches:
      - main
    paths:
      - 'apps/historia/**'
      - '.github/workflows/historia-main.yml'
  release:
    types: [published]

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_REPOSITORY: losolio/historia

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --filter @eventuras/historia... --frozen-lockfile

      - name: Lint
        run: pnpm --filter @eventuras/historia lint

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    # Only build on PR or push to main - releases will reuse staging image
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
      # Output the SHA-based tag for staging builds to enable release retagging
      staging-sha-tag: ${{ steps.staging-tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate staging SHA tag
        id: staging-tag
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Create a deterministic tag based on commit SHA for staging
          echo "tag=${{ env.DOCKER_REPOSITORY }}:sha-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Generate Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REPOSITORY }}
          tags: |
            type=raw,value=dev-pr${{ github.event.pull_request.number }}-{{sha}},enable=${{ github.event_name == 'pull_request' }}
            type=raw,value=staging-{{date 'YYYYMMDD'}}-{{sha}},enable=${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
            type=raw,value=sha-${{ github.sha }},enable=${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/historia/Dockerfile
          push: true
          platforms: linux/amd64
          provenance: false
          sbom: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          secrets: |
            "cms_secret=${{ secrets.CMS_SECRET }}"
            "sentry_auth_token=${{ secrets.CMS_SENTRY_AUTH_TOKEN }}"
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            TURBO_TOKEN=${{ secrets.TURBO_TOKEN }}
            TURBO_TEAM=${{ secrets.TURBO_TEAM }}
            # IMPORTANT: These must be available at build time for Next.js image allowlisting
            # (/_next/image) and for client bundle replacement of NEXT_PUBLIC_*.
            NEXT_PUBLIC_CMS_URL=${{ vars.HISTORIA_NEXT_PUBLIC_CMS_URL }}
            CMS_ALLOWED_ORIGINS=${{ vars.HISTORIA_CMS_ALLOWED_ORIGINS }}
            FEATURE_SENTRY=${{ vars.FEATURE_SENTRY || 'false' }}
            NEXT_PUBLIC_SENTRY_DSN=${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}
            CMS_SENTRY_ORG=${{ secrets.CMS_SENTRY_ORG }}
            CMS_SENTRY_PROJECT=${{ secrets.CMS_SENTRY_PROJECT }}
            NEXT_PUBLIC_CMS_SENTRY_SEND_DEFAULT_PII=false

  # Retag existing staging image for releases - no rebuild needed!
  retag-for-release:
    name: Retag Image for Release
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'release' && contains(github.event.release.tag_name, '@eventuras/historia@')
    outputs:
      image-tag: ${{ steps.tags.outputs.primary-tag }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          # Extract version from tag like @eventuras/historia@0.14.0
          VERSION=$(echo "${{ github.event.release.tag_name }}" | sed -n 's/.*@eventuras\/historia@\(.*\)/\1/p')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Retag staging image for production
        id: tags
        run: |
          # The staging image was tagged with the commit SHA
          SOURCE_TAG="${{ env.DOCKER_REPOSITORY }}:sha-${{ github.sha }}"
          VERSION_TAG="${{ env.DOCKER_REPOSITORY }}:v${{ steps.version.outputs.version }}"
          LATEST_TAG="${{ env.DOCKER_REPOSITORY }}:latest"

          echo "Pulling existing staging image: ${SOURCE_TAG}"
          docker pull "${SOURCE_TAG}"

          echo "Retagging to version: ${VERSION_TAG}"
          docker tag "${SOURCE_TAG}" "${VERSION_TAG}"
          docker push "${VERSION_TAG}"

          echo "Retagging to latest: ${LATEST_TAG}"
          docker tag "${SOURCE_TAG}" "${LATEST_TAG}"
          docker push "${LATEST_TAG}"

          echo "primary-tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "âœ… Successfully retagged staging image for production release"

  deploy-dev:
    name: Deploy to Dev (PR Preview)
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.event_name == 'pull_request'
    environment:
      name: historia-dev
    steps:
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          images: ${{ needs.build-docker.outputs.image-tag }}

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸš€ Historia Dev Deployment

            **Status:** âœ… Deployed successfully

            **Environment:** historia-dev
            **Docker Image:** \`${{ needs.build-docker.outputs.image-tag }}\`
            **Commit:** ${{ github.sha }}

            The preview environment is ready for testing!`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: historia-prod
    steps:
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          images: ${{ needs.build-docker.outputs.image-tag }}

      - name: Create deployment notification
        run: |
          echo "âœ… Staging deployment successful"
          echo "Image: ${{ needs.build-docker.outputs.image-tag }}"

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: retag-for-release
    if: github.event_name == 'release' && contains(github.event.release.tag_name, '@eventuras/historia@')
    environment:
      name: historia-prod
    steps:
      - name: Deploy to Azure Web App (versioned)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          images: ${{ needs.retag-for-release.outputs.image-tag }}

      - name: Comment on release
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸŽ‰ Historia Production Deployment

            **Status:** âœ… Deployed successfully (reused staging build)

            **Version:** \`${{ needs.retag-for-release.outputs.version }}\`
            **Environment:** historia-prod
            **Docker Image:** \`${{ needs.retag-for-release.outputs.image-tag }}\`

            The new version is now live in production! ðŸš€

            _Note: This deployment reused the staging-tested Docker image - no rebuild required._`;

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: comment
            });
